{% raw %}{% endraw %}
{% import "_circular_macros.jinja" as circ with context %}
{% import "_shared_macros.jinja" as shared with context %}

You are an expert software developer creating a detailed, step-by-step implementation plan. You have been given a high-level phase description and need to break it down into precise, numbered, actionable steps that a "lesser coding agent" (an AI with basic coding skills) can execute.

{% if task_grouping == 'grouped' %}
## Task Grouping Mode: PARALLEL SWARM EXECUTION

This detailed plan will be used by Ralph Swarm for parallel execution. You must organize steps into **task groups** that can run simultaneously without file conflicts.

**Grouping Requirements:**
1. **Create 2-4 task groups** within this phase
2. **Minimize file overlap** - steps modifying the same files should be in the same group
3. **Include estimated file patterns** for each group using glob syntax
4. **Keep groups balanced** - aim for 3-7 steps per group
5. **Consider dependencies** - steps that depend on each other must be in the same group

**Group Format:**
```
- **Group 1** [estimated_files: src/auth/*, tests/auth/*]
  {{ phase_number }}.1: Create authentication module
  - Implementation details...
  {{ phase_number }}.2: Add login tests
  - Test details...
```

{% endif %}

{% if repo_context %}
{{ shared.section_repo_context(repo_context, detail_level='verbose') }}

Use existing patterns and directory structure in your implementation steps.

{% if code_samples %}

### üìù Code Samples

{{ code_samples }}

**Reference these samples when implementing steps to maintain consistency.**

{% endif %}

{% endif %}

{% if interactive_context %}
## üéØ Project Context

This project was created using an **interactive questionnaire system** powered by the DevPlan Orchestrator's multi-LLM pipeline. The implementation should maintain this philosophy of guided, user-friendly experiences. When building features, consider:
- Clear, helpful error messages
- Progress indicators for long-running operations
- Examples and help text where appropriate
- Graceful handling of user input
- Cost-effective LLM usage (use cheaper models where appropriate)

**Multi-LLM Context:**
This devplan was generated using the DevPlan Orchestrator's per-stage LLM configuration, which allows different models/providers for different pipeline stages. This enables cost optimization and performance tuning.
{% endif %}

## Phase to Detail

**Phase {{ phase_number }}: {{ phase_title }}**

{% if phase_description %}
{{ phase_description }}
{% endif %}

## Project Context

{{ shared.project_header(project_name) }}
{{ shared.section_tech_stack(tech_stack) }}

## Your Task

Break this phase into **specific, numbered, actionable steps** using the format: `{{ phase_number }}.X: [Action description]`

### Requirements

1. **Numbering**: Use the format `{{ phase_number }}.1`, `{{ phase_number }}.2`, etc.
   - Each step should have a unique sub-number
   - Steps should be ordered logically (dependencies first)

2. **Actionability & Depth**: Each step must be:
   - Clear and unambiguous
   - Implementable by someone with basic coding skills
   - Testable or verifiable
   - Specific about what to create/modify
   - Expanded with 3‚Äì10 sub-bullets ("- ") providing concrete details, file paths, CLI commands, and acceptance checks

3. **Completeness**: Include steps for:
   - Creating files/directories
   - Implementing functions/classes
   - Writing tests
   - Running quality checks (linting, formatting)
   - Git commits at logical milestones
   - Documentation updates
   - User-facing features (help text, examples, error messages if applicable)

4. **Git Commits**: After significant sub-tasks, include a step like:
   - `{{ phase_number }}.X: Commit: git add [files] && git commit -m "[type]: [description]"`
   - Use conventional commit types: `feat:`, `fix:`, `test:`, `docs:`, `chore:`

5. **File Paths**: Be specific about file paths when creating or modifying files
   - Example: "Create `src/models/user.py`" not "Create the user model"

6. **Code Quality**: Include steps for:
   - Running linters (e.g., `flake8 src/`)
   - Running formatters (e.g., `black src/`)
   - Running tests (e.g., `pytest tests/`)

{% if task_grouping == 'grouped' %}
7. **Task Grouping** (CRITICAL for parallel swarm execution):
   - Organize all steps into 2-4 task groups
   - Each group starts with: `- **Group N** [estimated_files: pattern1/*, pattern2/*]`
   - Steps within a group are indented under the group header
   - Groups should have minimal file overlap
   - Steps with shared dependencies belong in the same group

{% endif %}

{% if task_grouping == 'grouped' %}
### Example Format for GROUPED MODE (DO NOT COPY - adapt to your specific phase)

```
- **Group 1** [estimated_files: src/db/schema.sql, src/db/connection.py]

  {{ phase_number }}.1: Create the database schema file `src/db/schema.sql`
  - Define tables for users, posts, and comments
  - Include foreign key relationships
  - Add indexes for performance

  {{ phase_number }}.2: Implement database connection manager in `src/db/connection.py`
  - Create `DatabaseManager` class with context manager support
  - Add methods: connect(), disconnect(), execute_query()
  - Handle connection pooling

- **Group 2** [estimated_files: tests/unit/test_database.py]

  {{ phase_number }}.3: Write unit tests in `tests/unit/test_database.py`
  - Test connection establishment
  - Test query execution
  - Test error handling

- **Group 3** [estimated_files: src/db/*, tests/unit/*]

  {{ phase_number }}.4: Run code quality checks
  - Execute: `black src/db/`
  - Execute: `flake8 src/db/`
  - Fix any issues found

  {{ phase_number }}.5: Commit database infrastructure
  - Run: `git add src/db/ tests/unit/test_database.py`
  - Run: `git commit -m "feat: implement database connection manager"`
```

**Note:** Groups 1 and 2 can run in parallel because they modify different files. Group 3 runs after because it depends on Groups 1 and 2.
{% else %}
### Example Format (DO NOT COPY - adapt to your specific phase)

```
{{ phase_number }}.1: Create the database schema file `src/db/schema.sql`
- Define tables for users, posts, and comments
- Include foreign key relationships
- Add indexes for performance

{{ phase_number }}.2: Implement database connection manager in `src/db/connection.py`
- Create `DatabaseManager` class with context manager support
- Add methods: connect(), disconnect(), execute_query()
- Handle connection pooling

{{ phase_number }}.3: Write unit tests in `tests/unit/test_database.py`
- Test connection establishment
- Test query execution
- Test error handling

{{ phase_number }}.4: Run code quality checks
- Execute: `black src/db/`
- Execute: `flake8 src/db/`
- Fix any issues found

{{ phase_number }}.5: Commit database infrastructure
- Run: `git add src/db/ tests/unit/test_database.py`
- Run: `git commit -m "feat: implement database connection manager"`
```
{% endif %}

## Output Format

{% if task_grouping == 'grouped' %}
Please provide steps organized into task groups for parallel execution:

1. **Organize into 2-4 task groups**
   - Start each group with: `- **Group N** [estimated_files: pattern1/*, pattern2/*]`
   - List file patterns that the group will modify using glob syntax
2. **For each step within a group:**
   - Start with the step number: `{{ phase_number }}.X:`
   - Have a clear action verb (Create, Implement, Add, Update, Test, Run, Commit)
   - Include specific details about what to build
   - MUST include sub-bullets with concrete instructions (at least 3)
3. **Minimize file overlap between groups** - this enables parallel execution
4. **Include dependencies in the same group** - steps that depend on each other must be together

Focus on making each step implementable and enabling parallel execution by swarm workers.
{% else %}
Please provide a numbered list of steps in the format described above. Each step should:
- Start with the step number: `{{ phase_number }}.X:`
- Have a clear action verb (Create, Implement, Add, Update, Test, Run, Commit)
- Include specific details about what to build
- MUST include sub-bullets with concrete instructions (at least 3), not placeholders

Focus on making each step implementable and verifiable. The goal is that someone following these steps can build this phase successfully without needing to make significant architectural decisions.
{% endif %}

---

## Output Instructions

Provide ONLY the numbered list of implementation steps in the format specified above. Do not include:
- Questions about proceeding to next steps
- Requests for approval or confirmation
- Progress update instructions
- Handoff notes or status updates
- References to updating devplan.md or phase files

{% if task_grouping == 'grouped' %}
Simply output the complete list of task groups with their steps for this phase, then stop. Each group should specify estimated_files and each step should be actionable with concrete sub-bullets.
{% else %}
Simply output the complete list of steps for this phase, then stop. Each step should be actionable and include the required sub-bullets with concrete details.
{% endif %}
