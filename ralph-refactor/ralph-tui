#!/usr/bin/env bash
#
# Ralph TUI Launcher
#
# This script sets up and launches the Ralph TUI (Terminal User Interface).
# It handles virtual environment creation and dependency installation.

set -euo pipefail

# Resolve script location (follow symlinks)
SOURCE="${BASH_SOURCE[0]}"
while [ -L "$SOURCE" ]; do
    DIR=$(cd -P "$(dirname "$SOURCE")" && pwd)
    SOURCE=$(readlink "$SOURCE")
    case "$SOURCE" in
        /*) ;;
        *) SOURCE="$DIR/$SOURCE" ;;
    esac
done
SCRIPT_DIR=$(cd -P "$(dirname "$SOURCE")" && pwd)

TUI_DIR="$SCRIPT_DIR/tui"
VENV_DIR="$TUI_DIR/.venv"
REQUIREMENTS="$TUI_DIR/requirements.txt"
TUI_APP="$TUI_DIR/ralph_tui.py"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log_info() {
    echo -e "${BLUE}[ralph-tui]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[ralph-tui]${NC} $1"
}

log_error() {
    echo -e "${RED}[ralph-tui]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[ralph-tui]${NC} $1"
}

# Check Python availability
check_python() {
    if command -v python3 &>/dev/null; then
        PYTHON="python3"
    elif command -v python &>/dev/null; then
        local version
        version=$(python --version 2>&1 | grep -oP '\d+' | head -1)
        if [ "$version" -ge 3 ]; then
            PYTHON="python"
        else
            log_error "Python 3 is required but not found."
            exit 1
        fi
    else
        log_error "Python is not installed. Please install Python 3.9+."
        exit 1
    fi
    
    log_info "Using Python: $($PYTHON --version)"
}

# Create virtual environment if needed
setup_venv() {
    if [ ! -d "$VENV_DIR" ]; then
        log_info "Creating virtual environment..."
        $PYTHON -m venv "$VENV_DIR"
        log_success "Virtual environment created: $VENV_DIR"
    fi
}

# Install dependencies
install_deps() {
    local pip="$VENV_DIR/bin/pip"
    
    if [ ! -f "$VENV_DIR/.deps_installed" ] || [ "$REQUIREMENTS" -nt "$VENV_DIR/.deps_installed" ]; then
        log_info "Installing dependencies..."
        "$pip" install --upgrade pip -q
        "$pip" install -r "$REQUIREMENTS" -q
        touch "$VENV_DIR/.deps_installed"
        log_success "Dependencies installed"
    fi
}

# Run the TUI
run_tui() {
    local python_bin="$VENV_DIR/bin/python"
    
    log_info "Starting Ralph TUI..."
    exec "$python_bin" "$TUI_APP" "$@"
}

# Show help
show_help() {
    cat <<EOF
Ralph TUI - Terminal User Interface for Ralph AI Development Agent

USAGE:
    ralph-tui [OPTIONS]

OPTIONS:
    -h, --help      Show this help message
    --setup         Only set up virtual environment and install dependencies
    --clean         Remove virtual environment and start fresh

ENVIRONMENT:
    RALPH_DIR       State directory (default: ~/.ralph)

DESCRIPTION:
    Ralph TUI provides a full-screen terminal interface for:
    - Chat terminal for interacting with Ralph
    - Worker status pane showing swarm activity
    - Progress dashboard for task tracking
    - File browser for project exploration

    Projects are created in ~/.ralph/projects/ by default.

COMMANDS (inside TUI):
    /new <name>     Create a new project
    /open <name>    Open an existing project
    /devplan        Run Ralph in devplan mode
    /swarm [N]      Run Ralph swarm with N workers
    /swarm status   Show swarm status
    /swarm logs     Tail swarm logs
    /reiterate N    Re-queue worker N current task
    /settings       Open settings
    /status         Show current status
    /stop           Stop current Ralph run
    /help           Show help

KEYBOARD SHORTCUTS:
    Ctrl+N          New project
    Ctrl+R          Run swarm
    Ctrl+S          Stop swarm
    Ctrl+,          Settings
    Ctrl+T          Toggle theme
    F5              Refresh status
    Q               Quit

EOF
}

# Clean up
clean_venv() {
    if [ -d "$VENV_DIR" ]; then
        log_info "Removing virtual environment..."
        rm -rf "$VENV_DIR"
        log_success "Clean complete"
    else
        log_info "No virtual environment to clean"
    fi
}

# Main
main() {
    case "${1:-}" in
        -h|--help)
            show_help
            exit 0
            ;;
        --setup)
            check_python
            setup_venv
            install_deps
            log_success "Setup complete. Run 'ralph-tui' to start."
            exit 0
            ;;
        --clean)
            clean_venv
            exit 0
            ;;
    esac
    
    check_python
    setup_venv
    install_deps
    run_tui "$@"
}

main "$@"
