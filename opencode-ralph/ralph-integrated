#!/bin/bash

# Ralph - Autonomous AI Coding Loop for OpenCode
# Direct integration without plugin compilation

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

RALPH_DIR="${RALPH_DIR:-.ralph}"
STATE_FILE="$RALPH_DIR/state.json"
HISTORY_FILE="$RALPH_DIR/history.json"
PROGRESS_FILE="$RALPH_DIR/progress.md"
CONTEXT_FILE="$RALPH_DIR/context.md"
LOG_DIR="$RALPH_DIR/logs"

# Defaults
MAX_ITERATIONS="${MAX_ITERATIONS:-100}"
COMPLETION_PROMISE="${COMPLETION_PROMISE:-COMPLETE}"
VERBOSE="${VERBOSE:-false}"

log_info() { echo -e "${BLUE}[RALPH]${NC} $1"; }
log_success() { echo -e "${GREEN}[RALPH]${NC} $1"; }
log_warning() { echo -e "${YELLOW}[RALPH]${NC} $1"; }
log_error() { echo -e "${RED}[RALPH]${NC} $1"; }

init_ralph() {
    mkdir -p "$RALPH_DIR" "$LOG_DIR"
    
    if [ ! -f "$STATE_FILE" ]; then
        cat > "$STATE_FILE" << EOF
{
  "status": "idle",
  "iteration": 0,
  "prompt": "",
  "start_time": null,
  "last_activity": null,
  "context": ""
}
EOF
    fi
    
    if [ ! -f "$HISTORY_FILE" ]; then
        cat > "$HISTORY_FILE" << EOF
{
  "iterations": [],
  "total_time": 0,
  "success": false
}
EOF
    fi
    
    if [ ! -f "$PROGRESS_FILE" ]; then
        echo "# Ralph Progress Log" > "$PROGRESS_FILE"
        echo "" >> "$PROGRESS_FILE"
    fi
}

check_opencode() {
    if ! command -v opencode &> /dev/null; then
        log_error "OpenCode not found. Install from https://opencode.ai"
        exit 1
    fi
    log_success "OpenCode found: $(which opencode)"
}

get_state() { cat "$STATE_FILE" 2>/dev/null || echo '{}'; }

update_state() {
    local status="$1"
    local iteration="$2"
    local prompt="$3"
    local context="$4"
    
    local start_time=$(get_state | grep -o '"start_time": *"[^"]*"' | head -1 | cut -d'"' -f4 || echo "null")
    if [ "$status" = "running" ] && [ "$start_time" = "null" ] || [ -z "$start_time" ]; then
        start_time=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
    fi
    
    cat > "$STATE_FILE" << EOF
{
  "status": "$status",
  "iteration": $iteration,
  "prompt": "$prompt",
  "start_time": "$start_time",
  "last_activity": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
  "context": "$context"
}
EOF
}

add_context() {
    local context="$1"
    echo "$context" >> "$CONTEXT_FILE"
    log_info "Context added for next iteration"
}

get_and_clear_context() {
    if [ -f "$CONTEXT_FILE" ] && [ -s "$CONTEXT_FILE" ]; then
        local context=$(cat "$CONTEXT_FILE")
        rm -f "$CONTEXT_FILE"
        echo "$context"
    fi
}

run_iteration() {
    local prompt="$1"
    local iteration="$2"
    local context=$(get_and_clear_context)
    
    log_info "Iteration $iteration starting..."
    
    local full_prompt="$prompt"
    if [ -n "$context" ]; then
        full_prompt="$prompt

Additional context:
$context"
    fi
    
    local cmd="opencode run"
    
    local start_time=$(date +%s)
    local output
    output=$(echo "$full_prompt" | $cmd 2>&1) || true
    local end_time=$(date +%s)
    local duration=$((end_time - start_time))
    
    local log_file="$LOG_DIR/iteration_$(printf '%03d' $iteration).log"
    echo "$output" > "$log_file"
    
    local tools_used=$(echo "$output" | grep -oE '(Read|Write|Edit|Bash|grep|glob|edit|write|bash|read|glob|task|webfetch|websearch)' 2>/dev/null | sort -u | tr '\n' ' ' | head -c 200 || echo "")
    
    local history_entry=$(cat << EOF
{
  "iteration": $iteration,
  "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
  "duration": $duration,
  "tools_used": "$tools_used",
  "success": false
}
EOF
)
    
    local temp_history=$(mktemp)
    jq --argjson entry "$history_entry" '.iterations += [$entry]' "$HISTORY_FILE" > "$temp_history" 2>/dev/null && mv "$temp_history" "$HISTORY_FILE" || true
    
    echo "" >> "$PROGRESS_FILE"
    echo "## Iteration $iteration - $(date)" >> "$PROGRESS_FILE"
    echo "**Duration**: ${duration}s" >> "$PROGRESS_FILE"
    echo "**Tools**: $tools_used" >> "$PROGRESS_FILE"
    echo "" >> "$PROGRESS_FILE"
    echo "\`\`\`" >> "$PROGRESS_FILE"
    echo "$output" | head -50 >> "$PROGRESS_FILE"
    if [ $(echo "$output" | wc -l) -gt 50 ]; then
        echo "... (truncated)" >> "$PROGRESS_FILE"
    fi
    echo "\`\`\`" >> "$PROGRESS_FILE"
    
    if echo "$output" | grep -q "<promise>$COMPLETION_PROMISE</promise>"; then
        log_success "Completion promise detected!"
        return 0
    fi
    
    log_warning "Iteration $iteration completed without completion promise"
    return 1
}

check_struggle() {
    if ! command -v jq &> /dev/null; then
        return 0
    fi
    
    local iterations=$(jq '.iterations | length' "$HISTORY_FILE" 2>/dev/null || echo "0")
    
    if [ "$iterations" -lt 3 ]; then
        return 0
    fi
    
    local recent_tools=$(jq -r '.iterations[-3:] | .[] | .tools_used' "$HISTORY_FILE" 2>/dev/null | tr '\n' '\n' || echo "")
    
    if ! echo "$recent_tools" | grep -qE '(Write|Edit|bash|Bash)'; then
        log_warning "Struggle detected: No file modifications in recent iterations"
        return 1
    fi
    
    return 0
}

show_status() {
    local state=$(get_state)
    local status=$(echo "$state" | jq -r '.status' 2>/dev/null || echo "idle")
    local iteration=$(echo "$state" | jq -r '.iteration' 2>/dev/null || echo "0")
    local prompt=$(echo "$state" | jq -r '.prompt' 2>/dev/null || echo "")
    
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘                    Ralph Status                          â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    
    if [ "$status" = "idle" ]; then
        echo "ğŸ”„ No active loop"
        echo ""
        echo "Usage: ralph '<prompt>' [options]"
        echo ""
        echo "Options:"
        echo "  --max-iterations N    Stop after N iterations"
        echo "  --completion-promise T Completion signal"
        echo "  --verbose             Show detailed output"
        echo "  --status              Show current status"
        echo "  --add-context TEXT    Add context for next iteration"
        echo "  --clear-context       Clear pending context"
        echo ""
    else
        echo "ğŸ”„ ACTIVE LOOP"
        echo "   Iteration:    $iteration / $MAX_ITERATIONS"
        
        local start_time=$(echo "$state" | jq -r '.start_time' 2>/dev/null)
        if [ "$start_time" != "null" ] && [ -n "$start_time" ]; then
            local elapsed=$(($(date +%s) - $(date -d "$start_time" 2>/dev/null +%s || echo "0")))
            local minutes=$((elapsed / 60))
            local seconds=$((elapsed % 60))
            echo "   Elapsed:      ${minutes}m ${seconds}s"
        fi
        
        echo "   Promise:      $COMPLETION_PROMISE"
        echo "   Prompt:       $(echo "$prompt" | head -c 50)..."
        echo ""
        
        if [ -f "$HISTORY_FILE" ]; then
            local history_length=$(jq '.iterations | length' "$HISTORY_FILE" 2>/dev/null || echo "0")
            if [ "$history_length" -gt 0 ]; then
                echo "ğŸ“Š HISTORY ($history_length iterations)"
                jq -r '.iterations[-5:] | .[] | "   ğŸ”„ #\(.iteration): \(.duration)s | \(.tools_used)"' "$HISTORY_FILE" 2>/dev/null || true
                echo ""
            fi
        fi
        
        check_struggle && echo "âœ… Agent appears to be making progress" || echo "âš ï¸  Agent may be stuck"
    fi
    
    if [ -f "$CONTEXT_FILE" ] && [ -s "$CONTEXT_FILE" ]; then
        echo "ğŸ“ PENDING CONTEXT:"
        head -5 "$CONTEXT_FILE" | sed 's/^/   /'
        echo ""
    fi
}

run_loop() {
    local prompt="$1"
    
    init_ralph
    check_opencode
    
    log_info "Starting Ralph loop..."
    log_info "Prompt: $(echo "$prompt" | head -c 100)..."
    log_info "Completion promise: $COMPLETION_PROMISE"
    log_info "Max iterations: $MAX_ITERATIONS"
    echo ""
    
    update_state "running" 0 "$prompt" ""
    
    local iteration=0
    local success=false
    
    while [ $iteration -lt $MAX_ITERATIONS ]; do
        iteration=$((iteration + 1))
        update_state "running" $iteration "$prompt" ""
        
        if run_iteration "$prompt" $iteration; then
            success=true
            break
        fi
        
        if ! check_struggle; then
            log_warning "Agent appears to be struggling. Consider adding context."
        fi
        
        if [ "$VERBOSE" = "true" ]; then
            show_status
        else
            local current_iteration=$(jq '.iterations | length' "$HISTORY_FILE" 2>/dev/null || echo "0")
            local last_duration=$(jq -r '.iterations[-1].duration' "$HISTORY_FILE" 2>/dev/null || echo "0")
            echo -ne "\rğŸ”„ Iteration $current_iteration | Last run: ${last_duration}s | Press Ctrl+C to stop...\r"
        fi
    done
    
    update_state "completed" $iteration "$prompt" ""
    
    echo ""
    if [ "$success" = true ]; then
        log_success "âœ… Ralph loop completed successfully!"
        log_info "Completed in $iteration iteration(s)"
    else
        log_warning "âš ï¸  Ralph loop reached max iterations ($MAX_ITERATIONS)"
    fi
    
    local total_time=$(jq '[.iterations[].duration] | add' "$HISTORY_FILE" 2>/dev/null || echo "0")
    log_info "Total time: ${total_time}s"
    log_info "Logs: $LOG_DIR"
    log_info "Progress: $PROGRESS_FILE"
}

main() {
    local prompt=""
    local show_help=false
    local show_status_flag=false
    local add_context_flag=""
    local clear_context_flag=false
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --help|-h)
                show_help=true
                shift
                ;;
            --status)
                show_status_flag=true
                shift
                ;;
            --add-context)
                add_context_flag="$2"
                shift 2
                ;;
            --clear-context)
                clear_context_flag=true
                shift
                ;;
            --max-iterations)
                MAX_ITERATIONS="$2"
                shift 2
                ;;
            --completion-promise)
                COMPLETION_PROMISE="$2"
                shift 2
                ;;
            --verbose|-v)
                VERBOSE=true
                shift
                ;;
            -*)
                log_error "Unknown option: $1"
                exit 1
                ;;
            *)
                prompt="$1"
                shift
                ;;
        esac
    done
    
    if [ "$show_help" = true ]; then
        cat << EOF
Ralph - Autonomous AI Coding Loop for OpenCode

USAGE:
    ralph "<prompt>" [options]
    ralph --status
    ralph --add-context "<hint>"
    ralph --clear-context

OPTIONS:
    --max-iterations N    Stop after N iterations (default: 100)
    --completion-promise T Text that signals completion (default: COMPLETE)
    --verbose, -v         Show detailed output
    --status              Show current loop status
    --add-context HINT    Add context for next iteration
    --clear-context       Clear pending context
    --help, -h            Show this help message

EXAMPLES:
    ralph "Create a hello.txt file. Output <promise>COMPLETE</promise> when done."
    ralph "Build a REST API with tests. Output <promise>COMPLETE</promise> when all tests pass." --max-iterations 20
    ralph --status
    ralph --add-context "Focus on fixing the auth module first"

For more information, visit: https://github.com/anomalyco/opencode
EOF
        exit 0
    fi
    
    if [ "$show_status_flag" = true ]; then
        init_ralph
        show_status
        exit 0
    fi
    
    if [ -n "$add_context_flag" ]; then
        init_ralph
        add_context "$add_context_flag"
        exit 0
    fi
    
    if [ "$clear_context_flag" = true ]; then
        rm -f "$CONTEXT_FILE"
        log_info "Context cleared"
        exit 0
    fi
    
    if [ -z "$prompt" ]; then
        log_error "No prompt provided. Use: ralph '<prompt>'"
        exit 1
    fi
    
    run_loop "$prompt"
}

main "$@"